{"version":3,"sources":["../../src/wechat/g.js"],"names":["sha1","require","getRawBody","util","Wechat","materal","module","exports","opts","handler","wechat","next","that","console","log","query","token","signature","timestamp","nonce","echostr","str","sort","join","sha","path","imgList","call","newsList","method","body","req","length","limit","encoding","charset","data","parseXMLAsync","content","message","formatMessage","xml","weixin","reply"],"mappings":"AAAA;;;AAGA;;;;;;;;AACA,IAAIA,OAAOC,QAAQ,MAAR,CAAX;AACA,IAAIC,aAAaD,QAAQ,UAAR,CAAjB;AACA,IAAIE,OAAOF,QAAQ,QAAR,CAAX;AACA,IAAIG,SAASH,QAAQ,UAAR,CAAb;AACA,IAAII,UAAUJ,QAAQ,mBAAR,CAAd;;AAGAK,OAAOC,OAAP,GAAiB,UAAUC,IAAV,EAAgBC,OAAhB,EAAyB;AACtC,QAAIC,SAAS,IAAIN,MAAJ,CAAWI,IAAX,CAAb;AACA,sCAAO,iBAAWG,IAAX;AAAA;AAAA;AAAA;AAAA;AAAA;AACCC,4BADD,GACQ,IADR;;AAEHC,gCAAQC,GAAR,CAAY,KAAKC,KAAjB;;AAEIC,6BAJD,GAISR,KAAKQ,KAJd;AAKCC,iCALD,GAKa,KAAKF,KAAL,CAAWE,SALxB;AAMCC,iCAND,GAMa,KAAKH,KAAL,CAAWG,SANxB;AAOCC,6BAPD,GAOS,KAAKJ,KAAL,CAAWI,KAPpB;AAQCC,+BARD,GAQW,KAAKL,KAAL,CAAWK,OARtB;AASCC,2BATD,GASO,CAACL,KAAD,EAAQE,SAAR,EAAmBC,KAAnB,EAA0BG,IAA1B,GAAiCC,IAAjC,CAAsC,EAAtC,CATP;AAUCC,2BAVD,GAUOxB,KAAKqB,GAAL,CAVP;;AAWHR,gCAAQC,GAAR,CAAY,YAAY,KAAKW,IAA7B;;AAXG,8BAcC,KAAKA,IAAL,KAAc,6BAdf;AAAA;AAAA;AAAA;;AAAA;AAAA,+BAeQpB,QAAQqB,OAAR,CAAgBC,IAAhB,CAAqB,IAArB,EAA2BhB,IAA3B,CAfR;;AAAA;AAAA;AAAA;;AAAA;AAAA,8BAgBQ,KAAKc,IAAL,KAAc,4BAhBtB;AAAA;AAAA;AAAA;;AAAA;AAAA,+BAiBQpB,QAAQuB,QAAR,CAAiBD,IAAjB,CAAsB,IAAtB,EAA4BhB,IAA5B,CAjBR;;AAAA;AAAA;AAAA;;AAAA;AAAA,8BAkBQ,KAAKc,IAAL,KAAc,GAlBtB;AAAA;AAAA;AAAA;;AAAA,8BAmBK,KAAKI,MAAL,KAAgB,KAnBrB;AAAA;AAAA;AAAA;;AAoBK,4BAAIL,QAAQP,SAAZ,EAAuB;AACnB,iCAAKa,IAAL,GAAYV,UAAU,EAAtB;AACH,yBAFD,MAEO;AACH,iCAAKU,IAAL,GAAY,OAAZ;AACH;AAxBN;AAAA;;AAAA;AAAA,8BAyBY,KAAKD,MAAL,KAAgB,MAzB5B;AAAA;AAAA;AAAA;;AAAA,8BA0BSL,QAAQP,SA1BjB;AAAA;AAAA;AAAA;;AA2BS,6BAAKa,IAAL,GAAY,OAAZ;AACA;AA5BT,yDA6BgB,KA7BhB;;AAAA;AAAA;AAAA,+BA+BsB5B,WAAW,KAAK6B,GAAhB,EAAqB;AAClCC,oCAAQ,KAAKA,MADqB;AAElCC,mCAAO,KAF2B;AAGlCC,sCAAU,KAAKC;AAHmB,yBAArB,CA/BtB;;AAAA;AA+BSC,4BA/BT;AAAA;AAAA,+BAoCyBjC,KAAKkC,aAAL,CAAmBD,IAAnB,CApCzB;;AAAA;AAoCSE,+BApCT;AAqCSC,+BArCT,GAqCmBpC,KAAKqC,aAAL,CAAmBF,QAAQG,GAA3B,CArCnB;;AAsCK,6BAAKC,MAAL,GAAcH,OAAd;AACA;AAvCL;AAAA,+BAwCY9B,QAAQkB,IAAR,CAAa,IAAb,EAAmBhB,IAAnB,CAxCZ;;AAAA;AAyCK,4BAAI,KAAKmB,IAAT,EAAe;AACXpB,mCAAOiC,KAAP,CAAahB,IAAb,CAAkB,IAAlB;AACH;;AA3CN;AAAA;AAAA,+BA8CGhB,IA9CH;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAP;AAgDH,CAlDD","file":"g.js","sourcesContent":["/**\r\n * Created by yao on 2016/10/29.\r\n */\r\n\"use strict\";\r\nvar sha1 = require('sha1');\r\nvar getRawBody = require('raw-body');\r\nvar util = require('./util');\r\nvar Wechat = require('./wechat');\r\nvar materal = require('./service/materal');\r\n\r\n\r\nmodule.exports = function (opts, handler) {\r\n    var wechat = new Wechat(opts);\r\n    return function *(next) {\r\n        var that = this;\r\n        console.log(this.query);\r\n\r\n        var token = opts.token;\r\n        var signature = this.query.signature;\r\n        var timestamp = this.query.timestamp;\r\n        var nonce = this.query.nonce;\r\n        var echostr = this.query.echostr;\r\n        var str = [token, timestamp, nonce].sort().join('');\r\n        var sha = sha1(str);\r\n        console.log('我是访问路径：' + this.path);\r\n\r\n\r\n        if (this.path === '/material/materialInfoImage') {\r\n            yield  materal.imgList.call(this, next);\r\n        } else if (this.path === '/material/materialInfoNews') {\r\n            yield  materal.newsList.call(this, next);\r\n        } else if (this.path === '/') {\r\n            if (this.method === 'GET') {\r\n                if (sha === signature) {\r\n                    this.body = echostr + '';\r\n                } else {\r\n                    this.body = 'wrong';\r\n                }\r\n            } else if (this.method === 'POST') {\r\n                if (sha !== signature) {\r\n                    this.body = 'wrong';\r\n                    //this.body = echostr + '';\r\n                    return false;\r\n                }\r\n                var data = yield getRawBody(this.req, {\r\n                    length: this.length,\r\n                    limit: 'lmb',\r\n                    encoding: this.charset\r\n                });\r\n                var content = yield util.parseXMLAsync(data);\r\n                var message = util.formatMessage(content.xml);\r\n                this.weixin = message;\r\n                //把message拿到后就交给业务层;\r\n                yield  handler.call(this, next);\r\n                if (this.body) {\r\n                    wechat.reply.call(this);\r\n                }\r\n            }\r\n        }\r\n        yield next;\r\n    };\r\n};\r\n"]}