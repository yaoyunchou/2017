{"version":3,"sources":["../../src/wechat/g.js"],"names":["sha1","require","getRawBody","util","Wechat","materal","module","exports","opts","handler","wechat","next","that","console","log","query","token","signature","timestamp","nonce","echostr","str","sort","join","sha","path","imgList","call","newsList","method","body","req","length","limit","encoding","charset","data","parseXMLAsync","content","message","formatMessage","xml","weixin","reply"],"mappings":"AAAA;;;AAGA;;;;;;;;AACA,IAAIA,OAAOC,QAAQ,MAAR,CAAX;AACA,IAAIC,aAAaD,QAAQ,UAAR,CAAjB;AACA,IAAIE,OAAOF,QAAQ,QAAR,CAAX;AACA,IAAIG,SAASH,QAAQ,UAAR,CAAb;AACA,IAAII,UAAUJ,QAAQ,mBAAR,CAAd;;AAGAK,OAAOC,OAAP,GAAiB,UAAUC,IAAV,EAAgBC,OAAhB,EAAyB;AACtC,QAAIC,SAAS,IAAIN,MAAJ,CAAWI,IAAX,CAAb;AACA,oDAAO,iBAAWG,IAAX;AAAA;AAAA;AAAA;AAAA;AAAA;AACCC,gCADD,GACQ,IADR;;AAEHC,oCAAQC,GAAR,CAAY,KAAKC,KAAjB;;AAEIC,iCAJD,GAISR,KAAKQ,KAJd;AAKCC,qCALD,GAKa,KAAKF,KAAL,CAAWE,SALxB;AAMCC,qCAND,GAMa,KAAKH,KAAL,CAAWG,SANxB;AAOCC,iCAPD,GAOS,KAAKJ,KAAL,CAAWI,KAPpB;AAQCC,mCARD,GAQW,KAAKL,KAAL,CAAWK,OARtB;AASCC,+BATD,GASO,CAACL,KAAD,EAAQE,SAAR,EAAmBC,KAAnB,EAA0BG,IAA1B,GAAiCC,IAAjC,CAAsC,EAAtC,CATP;AAUCC,+BAVD,GAUOxB,KAAKqB,GAAL,CAVP;;AAWHR,oCAAQC,GAAR,CAAY,YAAY,KAAKW,IAA7B;;AAXG,kCAcC,KAAKA,IAAL,KAAc,6BAdf;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAeQpB,QAAQqB,OAAR,CAAgBC,IAAhB,CAAqB,IAArB,EAA2BhB,IAA3B,CAfR;;AAAA;AAAA;AAAA;;AAAA;AAAA,kCAgBQ,KAAKc,IAAL,KAAc,4BAhBtB;AAAA;AAAA;AAAA;;AAAA;AAAA,mCAiBQpB,QAAQuB,QAAR,CAAiBD,IAAjB,CAAsB,IAAtB,EAA4BhB,IAA5B,CAjBR;;AAAA;AAAA;AAAA;;AAAA;AAAA,kCAkBQ,KAAKc,IAAL,KAAc,GAlBtB;AAAA;AAAA;AAAA;;AAAA,kCAmBK,KAAKI,MAAL,KAAgB,KAnBrB;AAAA;AAAA;AAAA;;AAoBK,gCAAIL,QAAQP,SAAZ,EAAuB;AACnB,qCAAKa,IAAL,GAAYV,UAAU,EAAtB;AACH,6BAFD,MAEO;AACH,qCAAKU,IAAL,GAAY,OAAZ;AACH;AAxBN;AAAA;;AAAA;AAAA,kCAyBY,KAAKD,MAAL,KAAgB,MAzB5B;AAAA;AAAA;AAAA;;AAAA,kCA0BSL,QAAQP,SA1BjB;AAAA;AAAA;AAAA;;AA2BS,iCAAKa,IAAL,GAAY,OAAZ;AACA;AA5BT,6DA6BgB,KA7BhB;;AAAA;AAAA;AAAA,mCA+BsB5B,WAAW,KAAK6B,GAAhB,EAAqB;AAClCC,wCAAQ,KAAKA,MADqB;AAElCC,uCAAO,KAF2B;AAGlCC,0CAAU,KAAKC;AAHmB,6BAArB,CA/BtB;;AAAA;AA+BSC,gCA/BT;AAAA;AAAA,mCAoCyBjC,KAAKkC,aAAL,CAAmBD,IAAnB,CApCzB;;AAAA;AAoCSE,mCApCT;AAqCSC,mCArCT,GAqCmBpC,KAAKqC,aAAL,CAAmBF,QAAQG,GAA3B,CArCnB;;AAsCK,iCAAKC,MAAL,GAAcH,OAAd;AACA;AAvCL;AAAA,mCAwCY9B,QAAQkB,IAAR,CAAa,IAAb,EAAmBhB,IAAnB,CAxCZ;;AAAA;AAyCK,gCAAI,KAAKmB,IAAT,EAAe;AACXpB,uCAAOiC,KAAP,CAAahB,IAAb,CAAkB,IAAlB;AACH;;AA3CN;AAAA;AAAA,mCA8CGhB,IA9CH;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAAP;AAAA;AAgDH,CAlDD","file":"g.js","sourcesContent":["/**\n * Created by yao on 2016/10/29.\n */\n\"use strict\";\nvar sha1 = require('sha1');\nvar getRawBody = require('raw-body');\nvar util = require('./util');\nvar Wechat = require('./wechat');\nvar materal = require('./service/materal');\n\n\nmodule.exports = function (opts, handler) {\n    var wechat = new Wechat(opts);\n    return function *(next) {\n        var that = this;\n        console.log(this.query);\n\n        var token = opts.token;\n        var signature = this.query.signature;\n        var timestamp = this.query.timestamp;\n        var nonce = this.query.nonce;\n        var echostr = this.query.echostr;\n        var str = [token, timestamp, nonce].sort().join('');\n        var sha = sha1(str);\n        console.log('我是访问路径：' + this.path);\n\n\n        if (this.path === '/material/materialInfoImage') {\n            yield  materal.imgList.call(this, next);\n        } else if (this.path === '/material/materialInfoNews') {\n            yield  materal.newsList.call(this, next);\n        } else if (this.path === '/') {\n            if (this.method === 'GET') {\n                if (sha === signature) {\n                    this.body = echostr + '';\n                } else {\n                    this.body = 'wrong';\n                }\n            } else if (this.method === 'POST') {\n                if (sha !== signature) {\n                    this.body = 'wrong';\n                    //this.body = echostr + '';\n                    return false;\n                }\n                var data = yield getRawBody(this.req, {\n                    length: this.length,\n                    limit: 'lmb',\n                    encoding: this.charset\n                });\n                var content = yield util.parseXMLAsync(data);\n                var message = util.formatMessage(content.xml);\n                this.weixin = message;\n                //把message拿到后就交给业务层;\n                yield  handler.call(this, next);\n                if (this.body) {\n                    wechat.reply.call(this);\n                }\n            }\n        }\n        yield next;\n    };\n};\n"]}