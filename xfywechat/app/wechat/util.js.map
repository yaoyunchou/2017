{"version":3,"sources":["../../src/wechat/util.js"],"names":["xml2js","require","Promise","_","template","exports","parseXMLAsync","xml","console","log","resolve","reject","parseString","trim","err","content","formatMessage","result","message","keys","Object","forEach","val","item","key","Array","length","push","tpl","info","type","formUserName","toUsername","FromUserName","ToUserName","createTime","Date","getTime","msgType","toUserName","compiled"],"mappings":"AAAA;;;AAGA;AACA;;;;AACA,IAAIA,SAASC,QAAQ,QAAR,CAAb;AACA,IAAIC,UAAUD,QAAQ,UAAR,CAAd;AACA,IAAIE,IAAIF,QAAQ,QAAR,CAAR;AACA,IAAIG,WAAWH,QAAQ,YAAR,CAAf;AACAI,QAAQC,aAAR,GAAwB,UAASC,GAAT,EAAa;AACpCC,SAAQC,GAAR,CAAY,0BAAwBF,GAApC;AACA,QAAO,IAAIL,OAAJ,CAAY,UAAUQ,OAAV,EAAkBC,MAAlB,EAAyB;AAC3CX,SAAOY,WAAP,CAAmBL,GAAnB,EAAuB,EAACM,MAAK,IAAN,EAAvB,EAAmC,UAASC,GAAT,EAAaC,OAAb,EAAqB;AACvD,OAAGD,GAAH,EAAO;AACNH,WAAOG,GAAP;AACA,IAFD,MAEK;AACJJ,YAAQK,OAAR;AACA;AACD,GAND;AAOA,EARM,CAAP;AASA,CAXD;;AAaA,IAAIC,gBAAgB,SAASA,aAAT,CAAuBC,MAAvB,EAA8B;AACjD,KAAIC,UAAU,EAAd;AACA,KAAG,QAAQD,MAAR,yCAAQA,MAAR,OAAmB,QAAtB,EAA+B;AAC9B,MAAIE,OAAOC,OAAOD,IAAP,CAAYF,MAAZ,CAAX;AACAd,IAAEkB,OAAF,CAAUF,IAAV,EAAe,UAASG,GAAT,EAAa;AAC3B,OAAIC,OAAON,OAAOK,GAAP,CAAX;AACA,OAAIE,MAAMF,GAAV;AACA,OAAG,EAAEC,gBAAgBE,KAAlB,KAA2BF,KAAKG,MAAL,KAAgB,CAA9C,EAAgD;AAC/C;AACA;AACD,OAAGH,KAAKG,MAAL,KAAe,CAAlB,EAAqB;AACpB,QAAIJ,MAAMC,KAAK,CAAL,CAAV;AACA,QAAG,QAAQD,GAAR,yCAAQA,GAAR,OAAgB,QAAnB,EAA4B;AAC3BJ,aAAQM,GAAR,IAAeR,cAAcM,GAAd,CAAf;AACA,KAFD,MAEK;AACJJ,aAAQM,GAAR,IAAe,CAACF,OAAK,EAAN,EAAUT,IAAV,EAAf;AACA;AACD,IAPD,MAOK;AACJK,YAAQM,GAAR,IAAe,EAAf;AACArB,MAAEkB,OAAF,CAAUE,IAAV,EAAe,YAAU;AACxBL,aAAQM,GAAR,EAAaG,IAAb,CAAkBX,cAAcO,IAAd,CAAlB;AACA,KAFD;AAGA;AACD,GAnBD;AAoBA;AACD,QAAOL,OAAP;AACA,CA1BD;;AA4BAb,QAAQW,aAAR,GAAwBA,aAAxB;;AAEAX,QAAQuB,GAAR,GAAc,SAASA,GAAT,CAAab,OAAb,EAAqBG,OAArB,EAA6B;AAC1C,KAAIW,OAAO,EAAX;AACA,KAAIC,OAAO,MAAX;AACA,KAAIC,YAAJ,EAAiBC,UAAjB;AACA,KAAGd,OAAH,EAAW;AACVa,iBAAeb,QAAQe,YAAR,IAAsB,EAArC;AACAD,eAAad,QAAQgB,UAAR,IAAoB,EAAjC;AACA;;AAGD,KAAGnB,OAAH,EAAW;AACVe,SAAOf,QAAQe,IAAR,IAAcA,IAArB;AACA,MAAGf,mBAAmBU,KAAtB,EAA4B;AAC3BK,UAAO,MAAP;AACA;AACD;AACDD,MAAKd,OAAL,GAAeA,OAAf;AACAc,MAAKM,UAAL,GAAkB,IAAIC,IAAJ,GAAWC,OAAX,EAAlB;AACAR,MAAKS,OAAL,GAAeR,IAAf;AACAD,MAAKU,UAAL,GAAkBP,cAAa,EAA/B;AACAH,MAAKE,YAAL,GAAoBA,gBAAc,EAAlC;AACA,QAAO3B,SAASoC,QAAT,CAAkBX,IAAlB,CAAP;AACA,CAtBD","file":"util.js","sourcesContent":["/**\r\n * Created by yao on 2016/10/29.\r\n */\r\n/*global exports*/\r\n\"use strict\";\r\nvar xml2js = require('xml2js');\r\nvar Promise = require('bluebird');\r\nvar _ = require('lodash');\r\nvar template = require('./template');\r\nexports.parseXMLAsync = function(xml){\r\n\tconsole.log('this is before xml2js'+xml);\r\n\treturn new Promise(function (resolve,reject){\r\n\t\txml2js.parseString(xml,{trim:true},function(err,content){\r\n\t\t\tif(err){\r\n\t\t\t\treject(err);\r\n\t\t\t}else{\r\n\t\t\t\tresolve(content);\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n};\r\n\r\nvar formatMessage = function formatMessage(result){\r\n\tvar message = {};\r\n\tif(typeof  result === 'object'){\r\n\t\tvar keys = Object.keys(result);\r\n\t\t_.forEach(keys,function(val){\r\n\t\t\tvar item = result[val];\r\n\t\t\tvar key = val;\r\n\t\t\tif(!(item instanceof Array)|| item.length === 0){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif(item.length ===1 ){\r\n\t\t\t\tvar val = item[0];\r\n\t\t\t\tif(typeof  val === 'object'){\r\n\t\t\t\t\tmessage[key] = formatMessage(val);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tmessage[key] = (val||'').trim();\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tmessage[key] = [];\r\n\t\t\t\t_.forEach(item,function(){\r\n\t\t\t\t\tmessage[key].push(formatMessage(item));\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\treturn message;\r\n};\r\n\r\nexports.formatMessage = formatMessage;\r\n\r\nexports.tpl = function tpl(content,message){\r\n\tvar info = {};\r\n\tvar type = 'text';\r\n\tvar formUserName,toUsername;\r\n\tif(message){\r\n\t\tformUserName = message.FromUserName||'';\r\n\t\ttoUsername = message.ToUserName||'';\r\n\t}\r\n\r\n\r\n\tif(content){\r\n\t\ttype = content.type||type;\r\n\t\tif(content instanceof Array){\r\n\t\t\ttype = 'news';\r\n\t\t}\r\n\t}\r\n\tinfo.content = content;\r\n\tinfo.createTime = new Date().getTime();\r\n\tinfo.msgType = type;\r\n\tinfo.toUserName = toUsername ||'';\r\n\tinfo.formUserName = formUserName||'';\r\n\treturn template.compiled(info);\r\n};"]}