{"version":3,"sources":["../../src/wechat/util.js"],"names":["xml2js","require","Promise","_","template","exports","parseXMLAsync","xml","console","log","resolve","reject","parseString","trim","err","content","formatMessage","result","message","keys","Object","forEach","val","item","key","Array","length","push","tpl","info","type","formUserName","toUsername","FromUserName","ToUserName","createTime","Date","getTime","msgType","toUserName","compiled"],"mappings":"AAAA;;;AAGA;AACA;;;;AACA,IAAIA,SAASC,QAAQ,QAAR,CAAb;AACA,IAAIC,UAAUD,QAAQ,UAAR,CAAd;AACA,IAAIE,IAAIF,QAAQ,QAAR,CAAR;AACA,IAAIG,WAAWH,QAAQ,YAAR,CAAf;AACAI,QAAQC,aAAR,GAAwB,UAASC,GAAT,EAAa;AACpCC,SAAQC,GAAR,CAAY,0BAAwBF,GAApC;AACA,QAAO,IAAIL,OAAJ,CAAY,UAAUQ,OAAV,EAAkBC,MAAlB,EAAyB;AAC3CX,SAAOY,WAAP,CAAmBL,GAAnB,EAAuB,EAACM,MAAK,IAAN,EAAvB,EAAmC,UAASC,GAAT,EAAaC,OAAb,EAAqB;AACvD,OAAGD,GAAH,EAAO;AACNH,WAAOG,GAAP;AACA,IAFD,MAEK;AACJJ,YAAQK,OAAR;AACA;AACD,GAND;AAOA,EARM,CAAP;AASA,CAXD;;AAaA,IAAIC,gBAAgB,SAASA,aAAT,CAAuBC,MAAvB,EAA8B;AACjD,KAAIC,UAAU,EAAd;AACA,KAAG,QAAQD,MAAR,yCAAQA,MAAR,OAAmB,QAAtB,EAA+B;AAC9B,MAAIE,OAAOC,OAAOD,IAAP,CAAYF,MAAZ,CAAX;AACAd,IAAEkB,OAAF,CAAUF,IAAV,EAAe,UAASG,GAAT,EAAa;AAC3B,OAAIC,OAAON,OAAOK,GAAP,CAAX;AACA,OAAIE,MAAMF,GAAV;AACA,OAAG,EAAEC,gBAAgBE,KAAlB,KAA2BF,KAAKG,MAAL,KAAgB,CAA9C,EAAgD;AAC/C;AACA;AACD,OAAGH,KAAKG,MAAL,KAAe,CAAlB,EAAqB;AACpB,QAAIJ,MAAMC,KAAK,CAAL,CAAV;AACA,QAAG,QAAQD,GAAR,yCAAQA,GAAR,OAAgB,QAAnB,EAA4B;AAC3BJ,aAAQM,GAAR,IAAeR,cAAcM,GAAd,CAAf;AACA,KAFD,MAEK;AACJJ,aAAQM,GAAR,IAAe,CAACF,OAAK,EAAN,EAAUT,IAAV,EAAf;AACA;AACD,IAPD,MAOK;AACJK,YAAQM,GAAR,IAAe,EAAf;AACArB,MAAEkB,OAAF,CAAUE,IAAV,EAAe,YAAU;AACxBL,aAAQM,GAAR,EAAaG,IAAb,CAAkBX,cAAcO,IAAd,CAAlB;AACA,KAFD;AAGA;AACD,GAnBD;AAoBA;AACD,QAAOL,OAAP;AACA,CA1BD;;AA4BAb,QAAQW,aAAR,GAAwBA,aAAxB;;AAEAX,QAAQuB,GAAR,GAAc,SAASA,GAAT,CAAab,OAAb,EAAqBG,OAArB,EAA6B;AAC1C,KAAIW,OAAO,EAAX;AACA,KAAIC,OAAO,MAAX;AACA,KAAIC,YAAJ,EAAiBC,UAAjB;AACA,KAAGd,OAAH,EAAW;AACVa,iBAAeb,QAAQe,YAAR,IAAsB,EAArC;AACAD,eAAad,QAAQgB,UAAR,IAAoB,EAAjC;AACA;;AAGD,KAAGnB,OAAH,EAAW;AACVe,SAAOf,QAAQe,IAAR,IAAcA,IAArB;AACA,MAAGf,mBAAmBU,KAAtB,EAA4B;AAC3BK,UAAO,MAAP;AACA;AACD;AACDD,MAAKd,OAAL,GAAeA,OAAf;AACAc,MAAKM,UAAL,GAAkB,IAAIC,IAAJ,GAAWC,OAAX,EAAlB;AACAR,MAAKS,OAAL,GAAeR,IAAf;AACAD,MAAKU,UAAL,GAAkBP,cAAa,EAA/B;AACAH,MAAKE,YAAL,GAAoBA,gBAAc,EAAlC;AACA,QAAO3B,SAASoC,QAAT,CAAkBX,IAAlB,CAAP;AACA,CAtBD","file":"util.js","sourcesContent":["/**\n * Created by yao on 2016/10/29.\n */\n/*global exports*/\n\"use strict\";\nvar xml2js = require('xml2js');\nvar Promise = require('bluebird');\nvar _ = require('lodash');\nvar template = require('./template');\nexports.parseXMLAsync = function(xml){\n\tconsole.log('this is before xml2js'+xml);\n\treturn new Promise(function (resolve,reject){\n\t\txml2js.parseString(xml,{trim:true},function(err,content){\n\t\t\tif(err){\n\t\t\t\treject(err);\n\t\t\t}else{\n\t\t\t\tresolve(content);\n\t\t\t}\n\t\t});\n\t});\n};\n\nvar formatMessage = function formatMessage(result){\n\tvar message = {};\n\tif(typeof  result === 'object'){\n\t\tvar keys = Object.keys(result);\n\t\t_.forEach(keys,function(val){\n\t\t\tvar item = result[val];\n\t\t\tvar key = val;\n\t\t\tif(!(item instanceof Array)|| item.length === 0){\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif(item.length ===1 ){\n\t\t\t\tvar val = item[0];\n\t\t\t\tif(typeof  val === 'object'){\n\t\t\t\t\tmessage[key] = formatMessage(val);\n\t\t\t\t}else{\n\t\t\t\t\tmessage[key] = (val||'').trim();\n\t\t\t\t}\n\t\t\t}else{\n\t\t\t\tmessage[key] = [];\n\t\t\t\t_.forEach(item,function(){\n\t\t\t\t\tmessage[key].push(formatMessage(item));\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\treturn message;\n};\n\nexports.formatMessage = formatMessage;\n\nexports.tpl = function tpl(content,message){\n\tvar info = {};\n\tvar type = 'text';\n\tvar formUserName,toUsername;\n\tif(message){\n\t\tformUserName = message.FromUserName||'';\n\t\ttoUsername = message.ToUserName||'';\n\t}\n\n\n\tif(content){\n\t\ttype = content.type||type;\n\t\tif(content instanceof Array){\n\t\t\ttype = 'news';\n\t\t}\n\t}\n\tinfo.content = content;\n\tinfo.createTime = new Date().getTime();\n\tinfo.msgType = type;\n\tinfo.toUserName = toUsername ||'';\n\tinfo.formUserName = formUserName||'';\n\treturn template.compiled(info);\n};"]}