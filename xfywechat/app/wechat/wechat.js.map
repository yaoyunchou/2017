{"version":3,"sources":["../../src/wechat/wechat.js"],"names":["Promise","require","util","request","promisify","_","fs","api","Wechat","opts","that","appID","appSecret","getAccessToken","saveAccessToken","fetchAccessToken","prototype","access_token","expires_in","isValidAccessToken","resolve","then","data","JSON","parse","e","updateAccessToken","now","Date","getTime","url","accessToken","reject","json","response","uploadMaterial","type","material","permanent","form","uploadUrl","temporary","upload","extend","uploadImage","uploadNews","media","createReadStream","options","method","body","formData","res","_data","Error","catch","err","loadMaterial","offset","count","list","replace","getMaterialCount","reply","content","message","weixin","status","xml","tpl","module","exports"],"mappings":"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","file":"wechat.js","sourcesContent":["/**\r\n * Created by yao on 2016/11/2.\r\n */\r\n\"use strict\";\r\nvar Promise = require('bluebird');\r\nvar util = require('./util');\r\nvar request = Promise.promisify(require('request'));\r\nvar _ = require('lodash');\r\nvar fs = require('fs');\r\nvar api = require('./api');\r\n\r\nfunction Wechat(opts) {\r\n    var that = this;\r\n    this.appID = opts.appID;\r\n    this.appSecret = opts.appSecret;\r\n    this.getAccessToken = opts.getAccessToken;\r\n    this.saveAccessToken = opts.saveAccessToken;\r\n\r\n    this.fetchAccessToken();\r\n}\r\nWechat.prototype.fetchAccessToken = function () {\r\n    var that = this;\r\n    if (this.access_token && this.expires_in) {\r\n        if (this.isValidAccessToken(this)) {\r\n            return Promise.resolve(this);\r\n        }\r\n    }\r\n    this.getAccessToken().then(function (data) {\r\n        try {\r\n            data.JSON.parse(data);\r\n        }\r\n        catch (e) {\r\n            return that.updateAccessToken();\r\n        }\r\n        if (this.isValidAccessToken(data)) {\r\n            return Promise.resolve(data);\r\n        } else {\r\n            return that.updateAccessToken();\r\n        }\r\n    }).then(function (data) {\r\n        that.access_token = data.access_token;\r\n        that.expires_in = data.expires_in;\r\n        that.saveAccessToken(data);\r\n        return  Promise.resolve(data);\r\n    });\r\n};\r\nWechat.prototype.isValidAccessToken = function (data) {\r\n    if (!data || !data.access_token || !data.expires_in) {\r\n        return false;\r\n    }\r\n    //var access_token = data.access_token;\r\n    var expires_in = data.expires_in;\r\n    var now = new Date().getTime();\r\n    if (now < expires_in) {\r\n        return true;\r\n    } else {\r\n        return false;\r\n    }\r\n};\r\nWechat.prototype.updateAccessToken = function () {\r\n    var appID = this.appID;\r\n    var appSecret = this.appSecret;\r\n    var url = api.accessToken + '&appid=' + appID + '&secret=' + appSecret;\r\n\r\n    return new Promise(function (resolve, reject) {\r\n        request({url: url, json: true}).then(function (response) {\r\n            var data = response[1];\r\n            var now = new Date().getTime();\r\n            var expires_in = now + (data.expires_in - 20) * 1000;\r\n\r\n            data.expires_in = expires_in;\r\n            resolve(data);\r\n        });\r\n    });\r\n\r\n};\r\nWechat.prototype.uploadMaterial = function (type, material,permanent) {\r\n    /*1.上传的接口分为临时和永久上传\r\n    * 2.永久素材分为图片的,图文的,和其他的部分\r\n    * 3.图片和其他的都是需要路径的,所以这里的material是路径在图文的时候变成数组的数据\r\n    * */\r\n    var that = this;\r\n    var form = {};\r\n    var uploadUrl = api.material.temporary.upload;\r\n    //处理上传逻辑\r\n    if(permanent){\r\n        uploadUrl = api.material.permanent.upload;\r\n        _.extend(form,permanent);\r\n    }\r\n    if(type ==='newsImg'){\r\n        uploadUrl = api.material.permanent.uploadImage;\r\n    }\r\n    if(type === 'news'){\r\n        uploadUrl = api.material.permanent.uploadNews;\r\n        form = material;\r\n    }else{\r\n        form.media = fs.createReadStream(material);\r\n    }\r\n    return new Promise(function (resolve,reject) {\r\n        that.fetchAccessToken().then(function (data) {\r\n\r\n            var url = uploadUrl + 'access_token=' + data.access_token ;\r\n            if(permanent){\r\n                form.access_token = data.access_token;\r\n            }else{\r\n                url+= '&type=' + type;\r\n            }\r\n            var options = {\r\n                method: 'POST',\r\n                url: url,\r\n                json: true\r\n            };\r\n            if(type === 'news'){\r\n                options.body = form;\r\n            }else{\r\n                options.formData = form;\r\n            }\r\n            request(options).then(function (res) {\r\n                var _data = res[1];\r\n                if (_data) {\r\n                    resolve(_data);\r\n                } else {\r\n                    throw new Error('Upload material fails');\r\n                }\r\n            }).catch(function (err) {\r\n               reject(err);\r\n            });\r\n        });\r\n    });\r\n};\r\nWechat.prototype.loadMaterial = function loadMaterial(permanent) {\r\n    var that = this;\r\n    var form = {\r\n        type:'image',\r\n        offset:0,\r\n        count:10\r\n    };\r\n    if(permanent){\r\n        _.extend(form,permanent);\r\n    }\r\n    var uploadUrl = api.material.list;\r\n\r\n    return new Promise(function (resolve,reject) {\r\n        that.fetchAccessToken().then(function (data) {\r\n\r\n            var url = uploadUrl + 'access_token=' + data.access_token ;\r\n            url = url.replace(/https:/,'http:');\r\n            var options = {\r\n                method: 'POST',\r\n                url:url,\r\n                body:form,\r\n                json: true\r\n            };\r\n            request(options).then(function (res) {\r\n                var _data = res[1];\r\n                if (_data) {\r\n                    resolve(_data);\r\n                } else {\r\n                    throw new Error('load material fails');\r\n                }\r\n            }).catch(function (err) {\r\n                reject(err);\r\n            });\r\n        });\r\n    });\r\n};\r\n\r\nWechat.prototype.getMaterialCount = function getMaterialCount() {\r\n    var that = this;\r\n\r\n\r\n    var uploadUrl = api.material.count;\r\n\r\n    return new Promise(function (resolve,reject) {\r\n        that.fetchAccessToken().then(function (data) {\r\n\r\n            var url = uploadUrl + 'access_token=' + data.access_token ;\r\n            //url = url.replace('https://','http://')\r\n            var options = {\r\n                method: 'get',\r\n                url:url,\r\n                json: false\r\n            };\r\n            request(options).then(function (res) {\r\n                var _data = res[1];\r\n                if (_data) {\r\n                    resolve(_data);\r\n                } else {\r\n                    throw new Error('load material count fails');\r\n                }\r\n            }).catch(function (err) {\r\n                reject(err);\r\n            });\r\n        });\r\n    });\r\n};\r\nWechat.prototype.reply = function () {\r\n    var content = this.body;\r\n    var message = this.weixin;\r\n    this.status = 200;\r\n    if(this.api){\r\n        this.type = 'application/json';\r\n        this.body = content;\r\n    }else{\r\n        this.type = 'application/xml';\r\n        var xml = util.tpl(content, message);\r\n        this.body = xml;\r\n    }\r\n};\r\n\r\n\r\nmodule.exports = Wechat;"]}