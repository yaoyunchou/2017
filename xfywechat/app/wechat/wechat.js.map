{"version":3,"sources":["../../src/wechat/wechat.js"],"names":["Promise","require","util","request","promisify","_","fs","api","Wechat","opts","that","appID","appSecret","getAccessToken","saveAccessToken","fetchAccessToken","prototype","access_token","expires_in","isValidAccessToken","resolve","then","data","JSON","parse","e","updateAccessToken","now","Date","getTime","url","accessToken","reject","json","response","uploadMaterial","type","material","permanent","form","uploadUrl","temporary","upload","extend","uploadImage","uploadNews","media","createReadStream","options","method","body","formData","res","_data","Error","catch","err","loadMaterial","offset","count","list","replace","getMaterialCount","reply","content","message","weixin","status","xml","tpl","module","exports"],"mappings":"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","file":"wechat.js","sourcesContent":["/**\n * Created by yao on 2016/11/2.\n */\n\"use strict\";\nvar Promise = require('bluebird');\nvar util = require('./util');\nvar request = Promise.promisify(require('request'));\nvar _ = require('lodash');\nvar fs = require('fs');\nvar api = require('./api');\n\nfunction Wechat(opts) {\n    var that = this;\n    this.appID = opts.appID;\n    this.appSecret = opts.appSecret;\n    this.getAccessToken = opts.getAccessToken;\n    this.saveAccessToken = opts.saveAccessToken;\n\n    this.fetchAccessToken();\n}\nWechat.prototype.fetchAccessToken = function () {\n    var that = this;\n    if (this.access_token && this.expires_in) {\n        if (this.isValidAccessToken(this)) {\n            return Promise.resolve(this);\n        }\n    }\n    this.getAccessToken().then(function (data) {\n        try {\n            data.JSON.parse(data);\n        }\n        catch (e) {\n            return that.updateAccessToken();\n        }\n        if (this.isValidAccessToken(data)) {\n            return Promise.resolve(data);\n        } else {\n            return that.updateAccessToken();\n        }\n    }).then(function (data) {\n        that.access_token = data.access_token;\n        that.expires_in = data.expires_in;\n        that.saveAccessToken(data);\n        return  Promise.resolve(data);\n    });\n};\nWechat.prototype.isValidAccessToken = function (data) {\n    if (!data || !data.access_token || !data.expires_in) {\n        return false;\n    }\n    //var access_token = data.access_token;\n    var expires_in = data.expires_in;\n    var now = new Date().getTime();\n    if (now < expires_in) {\n        return true;\n    } else {\n        return false;\n    }\n};\nWechat.prototype.updateAccessToken = function () {\n    var appID = this.appID;\n    var appSecret = this.appSecret;\n    var url = api.accessToken + '&appid=' + appID + '&secret=' + appSecret;\n\n    return new Promise(function (resolve, reject) {\n        request({url: url, json: true}).then(function (response) {\n            var data = response[1];\n            var now = new Date().getTime();\n            var expires_in = now + (data.expires_in - 20) * 1000;\n\n            data.expires_in = expires_in;\n            resolve(data);\n        });\n    });\n\n};\nWechat.prototype.uploadMaterial = function (type, material,permanent) {\n    /*1.上传的接口分为临时和永久上传\n    * 2.永久素材分为图片的,图文的,和其他的部分\n    * 3.图片和其他的都是需要路径的,所以这里的material是路径在图文的时候变成数组的数据\n    * */\n    var that = this;\n    var form = {};\n    var uploadUrl = api.material.temporary.upload;\n    //处理上传逻辑\n    if(permanent){\n        uploadUrl = api.material.permanent.upload;\n        _.extend(form,permanent);\n    }\n    if(type ==='newsImg'){\n        uploadUrl = api.material.permanent.uploadImage;\n    }\n    if(type === 'news'){\n        uploadUrl = api.material.permanent.uploadNews;\n        form = material;\n    }else{\n        form.media = fs.createReadStream(material);\n    }\n    return new Promise(function (resolve,reject) {\n        that.fetchAccessToken().then(function (data) {\n\n            var url = uploadUrl + 'access_token=' + data.access_token ;\n            if(permanent){\n                form.access_token = data.access_token;\n            }else{\n                url+= '&type=' + type;\n            }\n            var options = {\n                method: 'POST',\n                url: url,\n                json: true\n            };\n            if(type === 'news'){\n                options.body = form;\n            }else{\n                options.formData = form;\n            }\n            request(options).then(function (res) {\n                var _data = res[1];\n                if (_data) {\n                    resolve(_data);\n                } else {\n                    throw new Error('Upload material fails');\n                }\n            }).catch(function (err) {\n               reject(err);\n            });\n        });\n    });\n};\nWechat.prototype.loadMaterial = function loadMaterial(permanent) {\n    var that = this;\n    var form = {\n        type:'image',\n        offset:0,\n        count:10\n    };\n    if(permanent){\n        _.extend(form,permanent);\n    }\n    var uploadUrl = api.material.list;\n\n    return new Promise(function (resolve,reject) {\n        that.fetchAccessToken().then(function (data) {\n\n            var url = uploadUrl + 'access_token=' + data.access_token ;\n            url = url.replace(/https:/,'http:');\n            var options = {\n                method: 'POST',\n                url:url,\n                body:form,\n                json: true\n            };\n            request(options).then(function (res) {\n                var _data = res[1];\n                if (_data) {\n                    resolve(_data);\n                } else {\n                    throw new Error('load material fails');\n                }\n            }).catch(function (err) {\n                reject(err);\n            });\n        });\n    });\n};\n\nWechat.prototype.getMaterialCount = function getMaterialCount() {\n    var that = this;\n\n\n    var uploadUrl = api.material.count;\n\n    return new Promise(function (resolve,reject) {\n        that.fetchAccessToken().then(function (data) {\n\n            var url = uploadUrl + 'access_token=' + data.access_token ;\n            //url = url.replace('https://','http://')\n            var options = {\n                method: 'get',\n                url:url,\n                json: false\n            };\n            request(options).then(function (res) {\n                var _data = res[1];\n                if (_data) {\n                    resolve(_data);\n                } else {\n                    throw new Error('load material count fails');\n                }\n            }).catch(function (err) {\n                reject(err);\n            });\n        });\n    });\n};\nWechat.prototype.reply = function () {\n    var content = this.body;\n    var message = this.weixin;\n    this.status = 200;\n    if(this.api){\n        this.type = 'application/json';\n        this.body = content;\n    }else{\n        this.type = 'application/xml';\n        var xml = util.tpl(content, message);\n        this.body = xml;\n    }\n};\n\n\nmodule.exports = Wechat;"]}