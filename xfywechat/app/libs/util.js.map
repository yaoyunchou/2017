{"version":3,"sources":["../../src/libs/util.js"],"names":["fs","require","Promise","exports","readFileAsync","fpth","encoding","resolve","reject","readFile","err","content","writeFileAsync","writeFile","request","iconv","FeedParser","fetchInfomation","fetch","feed","typeId","service","posts","options","url","headers","req","timeout","pool","setMaxListeners","setHeader","feedparser","on","done","res","stream","charset","Array","statusCode","emit","Error","getUrlParam","test","decodeStream","pipe","saveInfo","post","read","push","transToPost","string","name","reg","RegExp","r","match","unescape","mPost","title","link","description","pubDate","source","author","console","log","arguments"],"mappings":"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","file":"util.js","sourcesContent":["/**\r\n * Created by yao on 2016/10/29.\r\n */\r\n\"use strict\";\r\n\r\nvar fs = require('fs');\r\nvar Promise = require('bluebird');\r\n\r\nexports.readFileAsync = function (fpth, encoding) {\r\n\treturn new Promise(function (resolve, reject) {\r\n\t\tfs.readFile(fpth, encoding, function (err, content) {\r\n\t\t\tif (err) {\r\n\t\t\t\treject(err);\r\n\t\t\t} else {\r\n\t\t\t\tresolve(content);\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n};\r\nexports.writeFileAsync = function (fpth, content) {\r\n\treturn new Promise(function (resolve, reject) {\r\n\t\tfs.writeFile(fpth, content, function (err) {\r\n\t\t\tif (err) {\r\n\t\t\t\treject(err);\r\n\t\t\t} else {\r\n\t\t\t\tresolve(content);\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n};\r\nvar request = require('request'),\r\n\ticonv = require('iconv-lite'),\r\n\tFeedParser = require('feedparser');\r\nexports.fetchInfomation = function fetch(feed, typeId,service) {\r\n\tvar posts;\r\n\t// Define our streams  \r\n\r\n\tvar options = {\r\n\t\turl: feed,\r\n\t\theaders: {\r\n\t\t\t'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36',\r\n\t\t\t'accept': 'text/html,application/xhtml+xml'\r\n\t\t}\r\n\t};\r\n\tvar req = request(feed, {\r\n\t\ttimeout: 10000,\r\n\t\tpool: false\r\n\t});\r\n\treq.setMaxListeners(50);\r\n\t// Some feeds do not response without user-agent and accept headers.  \r\n\treq.setHeader('user-agent', 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36')\r\n\t\t.setHeader('accept', 'text/html,application/xhtml+xml');\r\n\r\n\tvar feedparser = new FeedParser();\r\n\r\n\t// Define our handlers  \r\n\treq.on('error', done);\r\n\treq.on('response', function (res) {\r\n\t\tvar stream = this,\r\n\t\t\ticonv, charset;\r\n\t\tposts = new Array();\r\n\t\tif (res.statusCode != 200) return this.emit('error', new Error('Bad status code'));\r\n\t\tcharset = getUrlParam((res.headers['content-type'] || ''), \"charset\");\r\n\t\tif (!iconv && charset && !/utf-*8/i.test(charset)) {\r\n\t\t\ttry {\r\n\t\t\t\ticonv = iconv.decodeStream('utf-8');\r\n\t\t\t\t//iconv.on('error', done);\r\n\t\t\t\tstream = this.pipe(iconv);\r\n\t\t\t} catch (err) {\r\n\t\t\t\tthis.emit('error', err);\r\n\t\t\t}\r\n\t\t}\r\n\t\tstream.pipe(feedparser);\r\n\t});\r\n\r\n\tfeedparser.on('error', done);\r\n\tfeedparser.on('end', function (err) {\r\n\t\t//console.log(posts);\r\n\t\tservice.saveInfo(posts); //存到数据库  \r\n\t});\r\n\tfeedparser.on('readable', function () {\r\n\t\tvar post;\r\n\t\twhile (post = this.read()) {\r\n\t\t\tposts.push(transToPost(post)); //保存到对象数组\r\n\t\t}\r\n\t});\r\n\r\n\tfunction getUrlParam(string, name) {\r\n\t\tvar reg = new RegExp(name + \"=([^&]*)(&|$)\"); //构造一个含有目标参数的正则表达式对象\r\n\t\tvar r = string.match(reg); //匹配目标参数\r\n\t\tif (r != null) return unescape(r[1]);\r\n\t\treturn null; //返回参数值\r\n\t}\r\n\r\n\tfunction transToPost(post) {\r\n\t\tvar mPost = {\r\n\t\t\ttitle: post.title,\r\n\t\t\tlink: post.link,\r\n\t\t\tdescription: post.description,\r\n\t\t\tpubDate: post.pubDate,\r\n\t\t\tsource: post.source,\r\n\t\t\tauthor: post.author,\r\n\t\t\ttypeId: typeId\r\n\t\t};\r\n\r\n\t\treturn mPost;\r\n\t}\r\n\r\n\tfunction done() {\r\n\t\tconsole.log(arguments);\r\n\t}\r\n}"]}